# Meal Planner (single source of truth)
# Uses add-on DNS name: addon_<slug>
# Reads everything from /week-totals (includes today + week + shopping)

rest:
  - resource: http://addon_local_meal_planner_api:8000/
    method: GET
    scan_interval: 30
    sensor:
      - name: Meal Planner API Status
        value_template: "{{ value_json.status }}"
        json_attributes:
          - service
          - version

  - resource: http://addon_local_meal_planner_api:8000/week-totals
    method: GET
    scan_interval: 30
    sensor:
      - name: Meal Planner Week Raw
        # Make the state something meaningful so it's obvious it's updating:
        value_template: "{{ value_json.last_updated }}"
        json_attributes:
          - week_start
          - last_updated
          - today_cost
          - today_totals
          - week_cost
          - week_totals
          - wed_shopping
          - sun_shopping

template:
  - sensor:
      - name: Meal Planner Last Updated
        state: "{{ state_attr('sensor.meal_planner_week_raw','last_updated') }}"

      - name: Meal Planner Week Start
        state: "{{ state_attr('sensor.meal_planner_week_raw','week_start') }}"

      - name: Meal Planner Today Cost
        unit_of_measurement: "£"
        state: "{{ (state_attr('sensor.meal_planner_week_raw','today_cost') | float(0)) | round(2) }}"

      - name: Meal Planner Today Totals
        state: "{{ (state_attr('sensor.meal_planner_week_raw','today_totals') or []) | tojson }}"

      - name: Meal Planner Week Cost
        unit_of_measurement: "£"
        state: "{{ (state_attr('sensor.meal_planner_week_raw','week_cost') | float(0)) | round(2) }}"

      - name: Meal Planner Week Totals
        state: "{{ (state_attr('sensor.meal_planner_week_raw','week_totals') or []) | tojson }}"

      - name: Meal Planner Wed Shopping Text
        state: "{{ (state_attr('sensor.meal_planner_week_raw','wed_shopping') or []) | tojson }}"

      - name: Meal Planner Sun Shopping Text
        state: "{{ (state_attr('sensor.meal_planner_week_raw','sun_shopping') or []) | tojson }}"

      - name: Meal Planner Wed Shopping Count
        state: "{{ (state_attr('sensor.meal_planner_week_raw','wed_shopping') or []) | count }}"

      - name: Meal Planner Sun Shopping Count
        state: "{{ (state_attr('sensor.meal_planner_week_raw','sun_shopping') or []) | count }}"
